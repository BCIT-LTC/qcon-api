#Following instructions (as of 2020-04-01): https://docs.gitlab.com/ee/ci/docker/using_kaniko.html
#Kaniko docs are here: https://github.com/GoogleContainerTools/kaniko
#While this example shows building to multiple registries for all branches, with a few modifications
#  it can be used to build non-master branches to a "dev" container registry and only build master to 
#  a production container registry
stages:
  - semver-tagging
  - build
  - release

#This job is for running semantic-versioning for tagging the commits with the correct version 
#on the main branch
#refer to : https://semantic-release.gitbook.io/semantic-release/usage/configuration for CLI configuration
semver_tagging_job:
  image: node:12-buster-slim
  stage: semver-tagging
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends git-core ca-certificates
    - export GIT_AUTHOR_NAME=$GITLAB_USER_LOGIN
    - export GIT_AUTHOR_EMAIL=$GITLAB_USER_EMAIL
    - export GIT_COMMITTER_NAME=$GITLAB_USER_LOGIN
    - export GIT_COMMITTER_EMAIL=$GITLAB_USER_EMAIL
    - npm install -g semantic-release @semantic-release/gitlab
  script:
    - semantic-release
      --branches main
      --repository-url 'https://issues.ltc.bcit.ca/web-apps/qcon/qcon-api/'
      --plugins '@semantic-release/commit-analyzer, @semantic-release/release-notes-generator'
  rules:
    - if: '$CI_COMMIT_BRANCH != "release"'
  # rules:
  #   - if: $CI_COMMIT_TAG
  #     when: never
    # - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'


#This job is for running semantic-versioning for releasing whenever there is a merge request
#on the release branch
semver_release:
  image: node:12-buster-slim
  stage: release
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends git-core ca-certificates
    - export GIT_AUTHOR_NAME=$GITLAB_USER_LOGIN
    - export GIT_AUTHOR_EMAIL=$GITLAB_USER_EMAIL
    - export GIT_COMMITTER_NAME=$GITLAB_USER_LOGIN
    - export GIT_COMMITTER_EMAIL=$GITLAB_USER_EMAIL
    - npm install -g semantic-release @semantic-release/gitlab
  script:
    - semantic-release
      --branches release
      --repository-url 'https://issues.ltc.bcit.ca/web-apps/qcon/qcon-api/'
      --plugins '@semantic-release/commit-analyzer, @semantic-release/release-notes-generator, @semantic-release/gitlab'
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_COMMIT_BRANCH == "release"'


#This job is for building the image with Kaniko
build_with_kaniko:
  # Hidden job to use as an "extends" template
  stage: build
  image: 
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/Dockerfile --destination $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG
  rules:
     - if: '$CI_COMMIT_TAG'