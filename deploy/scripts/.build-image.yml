# Build image with Kaniko and push to project registry
.build_image:
  image: 
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  variables:
    IMAGE_LABELS: >
      --label org.opencontainers.image.version=$VERSION_TAG
  script:
    - | 
      echo -e "\nBuilding and shipping image to $CI_REGISTRY_IMAGE\n"
      
      BUILD_TITLE=$(echo $CI_PROJECT_TITLE | tr " " "_")

      BUILD_DATE="'$(date '+%FT%T%z' | sed -E -n 's/(\+[0-9]{2})([0-9]{2})$/\1:\2/p')'" #rfc 3339 date

      IMAGE_LABELS="$IMAGE_LABELS \
        --label org.opencontainers.image.title=$BUILD_TITLE \
        --label org.opencontainers.image.description=$APP_DESCRIPTION \
        --label org.opencontainers.image.revision=$CI_COMMIT_SHA
        --label org.opencontainers.image.source=$CI_PROJECT_URL
        --label org.opencontainers.image.created=$BUILD_DATE \
        --label version=$VERSION_TAG \
        --label build_hash=$CI_COMMIT_SHA \
        --label build_short_sha=$CI_COMMIT_SHORT_SHA \
        --label build_timestamp=$BUILD_DATE \
        --label build_env=$BUILD_ENV \
        --label tagline=$APP_TAGLINE"
 
      ADDITIONAL_TAG_LIST="$ADDITIONAL_TAG_LIST $CI_COMMIT_SHORT_SHA"
      if [[ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]]; then
        ADDITIONAL_TAG_LIST="$ADDITIONAL_TAG_LIST latest";
      fi
      if [[ "$CI_COMMIT_TAG" ]]; then
        SHORT_TAG=$(echo $CI_COMMIT_TAG | sed 's/v//')
        ADDITIONAL_TAG_LIST="$ADDITIONAL_TAG_LIST $SHORT_TAG stable";
      fi
      if [[ -n "$ADDITIONAL_TAG_LIST" ]]; then 
        for TAG in $ADDITIONAL_TAG_LIST; do 
          FORMATTED_TAG_LIST="${FORMATTED_TAG_LIST} --tag $CI_REGISTRY_IMAGE:$TAG "; 
        done;
      fi
      
      # Reformat Docker tags to kaniko's --destination argument:
      FORMATTED_TAG_LIST=$(echo "${FORMATTED_TAG_LIST}" | sed s/\-\-tag/\-\-destination/g) 

      mkdir -p /kaniko/.docker
 
      echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(echo -n $CI_REGISTRY_USER:$CI_REGISTRY_PASSWORD | base64)\"}}}" \
        > /kaniko/.docker/config.json

      /kaniko/executor \
        --context $CI_PROJECT_DIR \
        --dockerfile $CI_PROJECT_DIR/Dockerfile $FORMATTED_TAG_LIST $IMAGE_LABELS